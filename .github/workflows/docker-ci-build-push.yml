# ============================================================
# üöÄ CI/CD ‚Äì Assistant Service (Docker ‚Üí Railway)
# ============================================================

name: üöÄ CI/CD ‚Äì Assistant Service (Docker ‚Üí Railway)

on:
  push:
    branches:
      - main

  workflow_dispatch:

  # Daily at 5:00 AM IST (23:30 UTC)
  schedule:
    - cron: "30 23 * * *"

jobs:
  ci-cd-assistant-service:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: pythoncodelife/assistant-service
      IMAGE_TAG: latest
      LIVE_URL: https://assistant-service-production-4c1b.up.railway.app/

    steps:

      # =====================================================
      # CHECKOUT
      # =====================================================
      - name: üßæ Checkout source code
        uses: actions/checkout@v4

      # =====================================================
      # BUILD TIMESTAMPS
      # =====================================================
      - name: ‚è±Ô∏è Generate build timestamps (UTC + IST)
        run: |
          echo "BUILD_TIME_UTC=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
          echo "BUILD_TIME_IST=$(TZ=Asia/Kolkata date '+%Y-%m-%d %I:%M:%S %p IST')" >> $GITHUB_ENV

      # =====================================================
      # DOCKER SETUP
      # =====================================================
      - name: üê≥ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # =====================================================
      # BUILD & PUSH IMAGE
      # =====================================================
      - name: üèóÔ∏è Build & Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      # =====================================================
      # DOCKER SUCCESS EMAIL
      # =====================================================
      - name: üìß Docker Build Success Email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚úÖ Docker Build Success | Assistant Service"
          html_body: |
            <h2>üê≥ Docker Image Built Successfully</h2>
            <p><b>Service:</b> Assistant Service</p>
            <p><b>Image:</b> ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}</p>
            <p><b>UTC:</b> ${{ env.BUILD_TIME_UTC }}</p>
            <p><b>IST:</b> ${{ env.BUILD_TIME_IST }}</p>
          to: ${{ secrets.MAIL_TO }}
          cc: ${{ secrets.MAIL_CC }}
          from: ${{ secrets.MAIL_USERNAME }}

      # =====================================================
      # DEPLOY TO RAILWAY
      # =====================================================
      - name: üöÄ Deploy to Railway
        run: |
          curl --fail -X POST "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{
              "query": "mutation { serviceInstanceDeploy(serviceId: \"'${{ secrets.RAILWAY_SERVICE_ID }}'\", environmentId: \"'${{ secrets.RAILWAY_ENVIRONMENT_ID }}'\") }"
            }'

      # =====================================================
      # DEPLOY SUCCESS EMAIL
      # =====================================================
      - name: üìß Deployment Success Email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üöÄ Deployment Success | Assistant Service"
          html_body: |
            <h2>üöÄ Assistant Service is LIVE</h2>
            <table border="1" cellpadding="8">
              <tr><td><b>Live URL</b></td>
                  <td><a href="${{ env.LIVE_URL }}">${{ env.LIVE_URL }}</a></td></tr>
              <tr><td><b>Docker Image</b></td>
                  <td>${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}</td></tr>
              <tr><td><b>UTC Deploy Time</b></td>
                  <td>${{ env.BUILD_TIME_UTC }}</td></tr>
              <tr><td><b>IST Deploy Time</b></td>
                  <td>${{ env.BUILD_TIME_IST }}</td></tr>
              <tr><td><b>Status</b></td>
                  <td style="color:green;"><b>LIVE</b></td></tr>
            </table>
          to: ${{ secrets.MAIL_TO }}
          cc: ${{ secrets.MAIL_CC }}
          from: ${{ secrets.MAIL_USERNAME }}

      # =====================================================
      # FAILURE EMAIL
      # =====================================================
      - name: ‚ùå CI/CD Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ùå CI/CD Failed | Assistant Service"
          html_body: |
            <h2 style="color:red;">‚ùå Pipeline Failed</h2>
            <p><b>Service:</b> Assistant Service</p>
            <p><b>UTC:</b> ${{ env.BUILD_TIME_UTC }}</p>
            <p><b>IST:</b> ${{ env.BUILD_TIME_IST }}</p>
          to: ${{ secrets.MAIL_TO }}
          cc: ${{ secrets.MAIL_CC }}
          from: ${{ secrets.MAIL_USERNAME }}
